<html lang="en">
  <head>
    <title>Chase Tx</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-size: 14px;
      }
      .sell {
        color: red;
      }
      a {
        color: blue !important;
      }
    </style>
  </head>

  <body>
    <div class="container mx-auto">
      <h1 class="text-xl">Chase Tx</h1>
      <hr />
      <button
        id="updateArticles"
        class="float-right bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded"
      >
        refresh articles</button
      ><br />

      <div id="content-html"></div>
    </div>

    <script>
      $.ajaxSetup({
        beforeSend: function (xhr) {
          const jwtToken =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkeWlieWdicWdvcHVlcXF3ZmxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgyODk5NjUsImV4cCI6MjAzMzg2NTk2NX0.DhPvUqEKRxH-PjL3d0-Zr1tQ25nyNNZOJQIhdBCIf0A"; // Or get from cookie/variable
          xhr.setRequestHeader("Authorization", "Bearer " + jwtToken);
        },
      });
      function getContent() {
    
        $.get("https://xdyibygbqgopueqqwflo.supabase.co/functions/v1/alerts?table=chase&orderby=date", function (data) {
            processContent(data);
        });
      }

      function processContent(data) {
        const createHtml = (tx) => {
          const { security, txtype, quantity, price, date, description } = tx;
          const url = `https://www.tradingview.com/chart/?symbol=${security}`;
          const ts = new Date(date).toLocaleDateString();
          const value = price * quantity;
          const percent = (value / 100000).toFixed(3);

          return `
        <li>
        <div class="link">
        <span class="timestamp">${date}</span> &nbsp;
        <a href="${url}" target="_blank">
          <span class="${txtype.toLowerCase().trim() === 'sell'? 'sell' : 'buy'}">${txtype}</span> 
          <b>${percent} ${security}</b> 
          &nbsp;&nbsp;&nbsp;at \$${price} x ${quantity} = <em>$${value}</em> </a> &nbsp;
        <span class="timestamp"><em class="text-slate-800">${date}</em></span> </div>
        
        </li>
        `;
        };

        const html =
          '<ul id="chase" class="posts">' +
            data.map(createHtml).join(" ") +
          "</ul>";
        $("#content-html").html(html);
      }

      $(document).ready(function () {
        getContent();
        $("#updateArticles").click(function (event) {
          event.preventDefault();
          getContent();
        });
      });
    </script>
  </body>
</html>
